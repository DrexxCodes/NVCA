<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>N.V.C.A - Cast Your Vote</title>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/jpg" href="hero.jpg" />
    <meta name="description"
    content="Welcome to the NAPSS, UNIZIK Chapter viewers choice award voting portal. Cast your vote for your favorite best dressed person and they may stand chance of winning 20K! Developed by Drexx Codes, Powered by Spotix Nigeria" />
  <style>
    /* General Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at 20% 80%, rgba(30, 30, 30, 0.8) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(50, 50, 50, 0.6) 0%, transparent 50%),
                  linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      color: #c0c0c0;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Glassmorphic Header */
    header {
      padding: 25px;
      background: rgba(17, 17, 17, 0.7);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-bottom: 1px solid rgba(192, 192, 192, 0.3);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-title {
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 2px;
      background: linear-gradient(45deg, #ffffff, #c0c0c0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .user-info {
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(192, 192, 192, 0.3);
      border-radius: 20px;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logout-btn {
      background: linear-gradient(45deg, #dc3545, #ff4757);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 15px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 40px 20px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .voting-header {
      text-align: center;
      margin-bottom: 50px;
    }

    .voting-header h1 {
      font-size: 3rem;
      margin-bottom: 15px;
      background: linear-gradient(45deg, #ffffff, #c0c0c0, #ffffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleGlow 3s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      from { filter: drop-shadow(0 0 10px rgba(192, 192, 192, 0.5)); }
      to { filter: drop-shadow(0 0 25px rgba(192, 192, 192, 0.8)); }
    }

    .voting-subtitle {
      font-size: 1.3rem;
      color: #e0e0e0;
      margin-bottom: 20px;
    }

    /* Gender toggle styles */
    .gender-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
      gap: 0;
    }

    .toggle-btn {
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(192, 192, 192, 0.3);
      color: #c0c0c0;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .toggle-btn:first-child {
      border-radius: 25px 0 0 25px;
      border-right: none;
    }

    .toggle-btn:last-child {
      border-radius: 0 25px 25px 0;
      border-left: none;
    }

    .toggle-btn.active {
      background: linear-gradient(45deg, #c0c0c0, #ffffff);
      color: #000;
      box-shadow: 0 6px 20px rgba(192, 192, 192, 0.3);
      transform: translateY(-2px);
    }

    .toggle-btn:not(.active):hover {
      background: rgba(50, 50, 50, 0.8);
      transform: translateY(-1px);
    }

    .toggle-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .toggle-btn:hover::before {
      left: 100%;
    }

    /* Category Sections */
    .category-section {
      margin-bottom: 80px;
      display: none;
    }

    .category-section.active {
      display: block;
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(30px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .category-header {
      background: rgba(17, 17, 17, 0.8);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(192, 192, 192, 0.3);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }

    .category-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #c0c0c0, transparent);
      animation: shimmer 4s infinite;
    }

    .category-header h2 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ffffff, #c0c0c0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .category-description {
      font-size: 1.1rem;
      color: #e0e0e0;
    }

    /* Contestants Grid */
    .contestants-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      padding: 0 20px;
    }

    .contestant-card {
      background: rgba(30, 30, 30, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(192, 192, 192, 0.3);
      border-radius: 25px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .contestant-card:hover {
      transform: translateY(-10px);
      border-color: rgba(192, 192, 192, 0.5);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
    }

    .contestant-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #c0c0c0, #ffffff, #c0c0c0);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .contestant-card:hover::before {
      opacity: 1;
    }

    .contestant-image {
      width: 200px;
      height: 200px;
      margin: 0 auto 25px;
      border-radius: 50%;
      background: linear-gradient(135deg, #333, #666);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      border: 3px solid rgba(192, 192, 192, 0.3);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .contestant-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .contestant-name {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 25px;
      color: #ffffff;
    }

    .vote-btn {
      background: linear-gradient(45deg, #c0c0c0, #ffffff);
      color: #000;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(192, 192, 192, 0.3);
      min-width: 120px;
    }

    .vote-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(192, 192, 192, 0.4);
    }

    .vote-btn:disabled {
      background: rgba(192, 192, 192, 0.3);
      color: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .voted-btn {
      background: linear-gradient(45deg, #28a745, #34d058);
      color: white;
      cursor: default;
      transform: none;
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
    }

    .voted-btn:hover {
      transform: none;
    }

    /* Loading States */
    .loading-container {
      text-align: center;
      padding: 60px;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(192, 192, 192, 0.3);
      border-top: 4px solid #c0c0c0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Messages */
    .message {
      padding: 15px 25px;
      border-radius: 15px;
      margin: 20px auto;
      font-weight: 500;
      display: none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-width: 500px;
    }

    .message.error {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid rgba(220, 53, 69, 0.5);
      color: #ff6b6b;
    }

    .message.success {
      background: rgba(40, 167, 69, 0.2);
      border: 1px solid rgba(40, 167, 69, 0.5);
      color: #4ade80;
    }

    /* Alert Modal */
    .alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeInOverlay 0.3s ease;
    }

    @keyframes fadeInOverlay {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .alert-modal {
      background: rgba(17, 17, 17, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(192, 192, 192, 0.4);
      border-radius: 25px;
      padding: 40px;
      text-align: center;
      max-width: 450px;
      margin: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: slideInModal 0.4s ease;
    }

    @keyframes slideInModal {
      from { opacity: 0; transform: translateY(-30px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .alert-modal h3 {
      color: #ffffff;
      margin-bottom: 20px;
      font-size: 1.6rem;
    }

    .alert-modal p {
      color: #e0e0e0;
      margin-bottom: 30px;
      font-size: 1.1rem;
      line-height: 1.5;
    }

    /* Vote Tag Input */
    .vote-tag-input {
      width: 100%;
      padding: 15px 20px;
      background: rgba(30, 30, 30, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(192, 192, 192, 0.3);
      border-radius: 12px;
      color: #ffffff;
      font-size: 1.2rem;
      text-align: center;
      font-weight: bold;
      letter-spacing: 2px;
      font-family: 'Courier New', monospace;
      text-transform: uppercase;
      margin: 20px 0;
      transition: all 0.3s ease;
    }

    .vote-tag-input:focus {
      outline: none;
      border-color: rgba(192, 192, 192, 0.6);
      box-shadow: 0 0 20px rgba(192, 192, 192, 0.2);
      background: rgba(30, 30, 30, 0.9);
    }

    .vote-tag-input.error {
      border-color: rgba(220, 53, 69, 0.6);
      box-shadow: 0 0 20px rgba(220, 53, 69, 0.2);
    }

    .tag-label {
      color: #e0e0e0;
      font-size: 1rem;
      margin-bottom: 10px;
      display: block;
    }

    .tag-hint {
      color: #888;
      font-size: 0.85rem;
      margin-top: 5px;
      font-style: italic;
    }

    .alert-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .alert-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 20px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .alert-btn.confirm {
      background: linear-gradient(45deg, #28a745, #34d058);
      color: white;
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
    }

    .alert-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
    }

    .alert-btn.confirm:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .alert-btn.cancel {
      background: rgba(60, 60, 60, 0.8);
      color: #c0c0c0;
      border: 1px solid rgba(192, 192, 192, 0.3);
    }

    .alert-btn.cancel:hover {
      background: rgba(80, 80, 80, 0.8);
      transform: translateY(-2px);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px;
      background: rgba(17, 17, 17, 0.6);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(192, 192, 192, 0.3);
      border-radius: 20px;
      margin: 20px;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #e0e0e0;
    }

    .empty-state p {
      color: #888;
    }

    /* Enhanced Footer */
    footer {
      padding: 30px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid rgba(192, 192, 192, 0.3);
      box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
      text-align: center;
      margin-top: auto;
    }

    footer a {
      color: #c0c0c0;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      position: relative;
    }

    footer a::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(45deg, #c0c0c0, #ffffff);
      transition: width 0.3s ease;
    }

    footer a:hover::after {
      width: 100%;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header-title {
        font-size: 1.5rem;
      }
      
      .user-info {
        flex-direction: column;
        gap: 10px;
        padding: 15px;
      }
      
      .contestants-grid {
        grid-template-columns: 1fr;
        padding: 0 10px;
      }
      
      .voting-header h1 {
        font-size: 2rem;
      }
      
      .category-header h2 {
        font-size: 2rem;
      }

      .alert-buttons {
        flex-direction: column;
        align-items: center;
      }

      .alert-btn {
        width: 150px;
      }

      .toggle-btn {
        padding: 12px 20px;
        font-size: 1rem;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .fade-in { animation: fadeIn 1s ease forwards; }
    .slide-up { animation: slideUp 0.8s ease forwards; }
    .delay-1 { animation-delay: 0.3s; }
    .delay-2 { animation-delay: 0.6s; }

    .vote-success {
      animation: pulse 0.6s ease;
    }

    /* Auth Check Overlay */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .auth-message {
      background: rgba(17, 17, 17, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(192, 192, 192, 0.3);
      border-radius: 25px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      margin: 20px;
    }

    .auth-message h2 {
      color: #ffffff;
      margin-bottom: 15px;
      font-size: 1.8rem;
    }

    .auth-message p {
      color: #c0c0c0;
      margin-bottom: 25px;
    }

    .auth-link {
      background: linear-gradient(45deg, #c0c0c0, #ffffff);
      color: #000;
      padding: 12px 25px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .auth-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(192, 192, 192, 0.4);
    }

    /* Connecting Popup */
    .connecting-alert {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      padding: 2rem;
      min-width: 300px;
    }

    .connecting-content h3 {
      color: #fff;
      font-size: 1.2rem;
      margin: 1rem 0 0.5rem 0;
      font-weight: 600;
    }

    .connecting-content p {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
      margin: 0;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
  </style>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, increment, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBnA5VAidJ20mtaoikC4p0oJyq6Ji2h-qU",
      authDomain: "coding-squad-249f7.firebaseapp.com",
      databaseURL: "https://coding-squad-249f7-default-rtdb.firebaseio.com",
      projectId: "coding-squad-249f7",
      storageBucket: "coding-squad-249f7.appspot.com",
      messagingSenderId: "385893863935",
      appId: "1:385893863935:web:e7b73f4deb14eef6d197ca"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    window.auth = auth;
    window.db = db;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.collection = collection;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.increment = increment;
    window.setDoc = setDoc;
  </script>
</head>
<body>
  <!-- Auth Check Overlay -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-message">
      <h2>Authentication Required</h2>
      <p>Please log in to access the voting page</p>
      <a href="auth.html" class="auth-link">Go to Login</a>
    </div>
  </div>

  <!-- Vote Confirmation Alert -->
  <div id="voteAlertOverlay" class="alert-overlay">
    <div class="alert-modal">
      <h3>Confirm Your Vote</h3>
      <p id="voteAlertMessage"></p>
      
      <label class="tag-label">Enter your Vote Tag:</label>
      <input type="text" id="voteTagInput" class="vote-tag-input" placeholder="Enter 6-character tag" maxlength="6">
      <div class="tag-hint">This tag was provided to you at the venue</div>
      
      <div class="alert-buttons">
        <button class="alert-btn confirm" onclick="confirmVote()" id="confirmVoteBtn">Yes, Vote</button>
        <button class="alert-btn cancel" onclick="cancelVote()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Already Voted Alert -->
  <div id="alreadyVotedOverlay" class="alert-overlay">
    <div class="alert-modal">
      <h3>Already Voted</h3>
      <p id="alreadyVotedMessage">Looks like you've voted already</p>
      <div class="alert-buttons">
        <button class="alert-btn cancel" onclick="closeAlreadyVotedAlert()">Okay</button>
      </div>
    </div>
  </div>

  <!-- Connecting Popup Overlay -->
  <div id="connectingOverlay" class="alert-overlay">
    <div class="alert-modal connecting-alert">
      <div class="connecting-content">
        <div class="spinner"></div>
        <h3>Connecting to N.V.C.A Server</h3>
        <p>NAPSS UNIZIK Dinner Night 2025</p>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="fade-in">
    <div class="header-left">
      <h1 class="header-title">N.V.C.A Voting</h1>
    </div>
    <div class="user-info">
      <span id="userEmail">Loading...</span>
      <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Voting Header -->
    <div class="voting-header fade-in">
      <h1>Cast Your Vote</h1>
      <p class="voting-subtitle">Choose the best dressed contestant in each category</p>
      
      <!-- Gender toggle buttons -->
      <div class="gender-toggle">
        <button class="toggle-btn active" onclick="switchCategory('male')" id="maleToggle">
          🤵 Male
        </button>
        <button class="toggle-btn" onclick="switchCategory('female')" id="femaleToggle">
          👗 Female
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading contestants...</p>
    </div>

    <!-- Success/Error Messages -->
    <div id="message" class="message"></div>

    <!-- Male Category -->
    <div id="maleSection" class="category-section active">
      <div class="category-header">
        <h2>🤵 Male Category</h2>
        <p class="category-description">Vote for the best dressed male contestant</p>
      </div>
      <div id="maleContestants" class="contestants-grid"></div>
    </div>

    <!-- Female Category -->
    <div id="femaleSection" class="category-section">
      <div class="category-header">
        <h2>👗 Female Category</h2>
        <p class="category-description">Vote for the best dressed female contestant</p>
      </div>
      <div id="femaleContestants" class="contestants-grid"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="fade-in">
    <p>Developed by <a href="https://drexx.vercel.app" target="_blank">Drexx Codes</a></p>
  </footer>

  <script>
    let currentUser = null;
    let userVotes = {};
    let pendingVote = null;
    let currentCategory = 'male';

    // Check authentication state
    window.addEventListener('load', () => {
      showConnectingPopup();
      
      if (window.onAuthStateChanged) {
        window.onAuthStateChanged(window.auth, async (user) => {
          if (user) {
            currentUser = user;
            hideConnectingPopup();
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('userEmail').textContent = user.email;
            await loadUserVotes();
            await loadContestants();
          } else {
            hideConnectingPopup();
            document.getElementById('authOverlay').style.display = 'flex';
          }
        });
      }
    });

    function switchCategory(category) {
      currentCategory = category;
      
      document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(category + 'Toggle').classList.add('active');
      
      document.querySelectorAll('.category-section').forEach(section => {
        section.classList.remove('active');
      });
      
      document.getElementById(category + 'Section').classList.add('active');
    }

    // Load user's previous votes
    async function loadUserVotes() {
      try {
        const userDocRef = window.doc(window.db, 'users', currentUser.uid);
        const userDoc = await window.getDoc(userDocRef);
        
        if (userDoc.exists()) {
          const userData = userDoc.data();
          userVotes = userData.votes || {};
        }
      } catch (error) {
        console.error('Error loading user votes:', error);
      }
    }

    // Load contestants from Firestore
    async function loadContestants() {
      try {
        showLoading();
        
        const maleSnapshot = await window.getDocs(window.collection(window.db, 'male'));
        const maleContestants = [];
        maleSnapshot.forEach((doc) => {
          maleContestants.push({ id: doc.id, ...doc.data() });
        });
        
        const femaleSnapshot = await window.getDocs(window.collection(window.db, 'female'));
        const femaleContestants = [];
        femaleSnapshot.forEach((doc) => {
          femaleContestants.push({ id: doc.id, ...doc.data() });
        });
        
        renderContestants('maleContestants', maleContestants, 'male');
        renderContestants('femaleContestants', femaleContestants, 'female');
        
        hideLoading();
        
      } catch (error) {
        console.error('Error loading contestants:', error);
        showMessage('Error loading contestants. Please refresh the page.', 'error');
        hideLoading();
      }
    }

    // Render contestants
    function renderContestants(containerId, contestants, category) {
      const container = document.getElementById(containerId);
      
      if (contestants.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No contestants yet</h3>
            <p>Contestants for this category will appear here soon.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = contestants.map(contestant => {
        const hasVoted = userVotes[category] === contestant.id;
        
        return `
          <div class="contestant-card" data-contestant-id="${contestant.id}">
            <div class="contestant-image">
              ${contestant.image ? 
                `<img src="${contestant.image}" alt="${contestant.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='${category === 'male' ? '🤵' : '👗'}'">` : 
                `${category === 'male' ? '🤵' : '👗'}`
              }
            </div>
            <h3 class="contestant-name">${contestant.name}</h3>
            <button 
              class="vote-btn ${hasVoted ? 'voted-btn' : ''}" 
              onclick="initiateVote('${contestant.id}', '${category}', '${contestant.name}')"
              ${hasVoted ? 'disabled' : ''}
            >
              ${hasVoted ? '✓ Voted' : 'Vote'}
            </button>
          </div>
        `;
      }).join('');
    }

    // Initiate voting with confirmation
    function initiateVote(contestantId, category, contestantName) {
      if (userVotes[category]) {
        showAlreadyVotedAlert(category);
        return;
      }

      pendingVote = { contestantId, category, contestantName };
      showVoteConfirmation(contestantName, category);
    }

    // Show vote confirmation alert
    function showVoteConfirmation(contestantName, category) {
      const message = `You're about to vote for ${contestantName} as the best ${category} dressed for the NAPSS Dinner Night`;
      document.getElementById('voteAlertMessage').textContent = message;
      document.getElementById('voteTagInput').value = '';
      document.getElementById('voteTagInput').classList.remove('error');
      document.getElementById('voteAlertOverlay').style.display = 'flex';
      
      // Focus on tag input
      setTimeout(() => {
        document.getElementById('voteTagInput').focus();
      }, 100);
    }

    // Show already voted alert
    function showAlreadyVotedAlert(category) {
      document.getElementById('alreadyVotedMessage').textContent = `You've already voted in the ${category} category`;
      document.getElementById('alreadyVotedOverlay').style.display = 'flex';
    }

    // Validate and confirm vote with tag
    async function confirmVote() {
      if (!pendingVote) return;
      
      const voteTag = document.getElementById('voteTagInput').value.trim().toUpperCase();
      const confirmBtn = document.getElementById('confirmVoteBtn');
      const tagInput = document.getElementById('voteTagInput');
      
      // Validate tag format
      if (!voteTag || voteTag.length !== 6) {
        tagInput.classList.add('error');
        showMessage('Please enter a valid 6-character vote tag', 'error');
        return;
      }
      
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Validating...';
      
      try {
        // Check if tag exists and is valid
        const tagDocRef = window.doc(window.db, 'tags', voteTag);
        const tagDoc = await window.getDoc(tagDocRef);
        
        if (!tagDoc.exists()) {
          tagInput.classList.add('error');
          showMessage('Invalid vote tag. Please check your tag and try again.', 'error');
          return;
        }
        
        const tagData = tagDoc.data();
        
        // Check if tag has tokens remaining
        if (tagData.token <= 0) {
          tagInput.classList.add('error');
          showMessage('This vote tag has been fully used already.', 'error');
          return;
        }
        
        // Check if tag is being used by a different user
        if (tagData.usedBy && tagData.usedBy !== currentUser.email) {
          tagInput.classList.add('error');
          showMessage('Oops, this token has been used already by another user.', 'error');
          return;
        }
        
        const { contestantId, category, contestantName } = pendingVote;
        
        // Close alert and show connecting
        document.getElementById('voteAlertOverlay').style.display = 'none';
        showConnectingPopup();
        
        // Disable all vote buttons temporarily
        const voteButtons = document.querySelectorAll('.vote-btn');
        voteButtons.forEach(btn => btn.disabled = true);

        // Update contestant vote count
        const contestantRef = window.doc(window.db, category, contestantId);
        await window.updateDoc(contestantRef, {
          votes: window.increment(1)
        });

        // Update user's votes
        const userRef = window.doc(window.db, 'users', currentUser.uid);
        const updatedVotes = { ...userVotes, [category]: contestantId };
        
        await window.updateDoc(userRef, {
          votes: updatedVotes
        });

        // Update tag: reduce token and set user
        await window.updateDoc(tagDocRef, {
          token: window.increment(-1),
          usedBy: currentUser.email,
          [`${category}UsedAt`]: new Date()
        });

        // Update local state
        userVotes[category] = contestantId;

        // Update UI
        const contestantCard = document.querySelector(`[data-contestant-id="${contestantId}"]`);
        const voteBtn = contestantCard.querySelector('.vote-btn');
        
        voteBtn.textContent = '✓ Voted';
        voteBtn.classList.add('voted-btn');
        voteBtn.disabled = true;
        
        contestantCard.classList.add('vote-success');
        setTimeout(() => contestantCard.classList.remove('vote-success'), 600);

        setTimeout(() => {
          hideConnectingPopup();
          showMessage(`Vote cast successfully for ${contestantName}!`, 'success');
        }, 1500);

      } catch (error) {
        console.error('Error validating tag or voting:', error);
        hideConnectingPopup();
        showMessage('Error processing your vote. Please try again.', 'error');
        document.getElementById('voteAlertOverlay').style.display = 'flex';
      } finally {
        // Re-enable other vote buttons
        setTimeout(() => {
          const voteButtons = document.querySelectorAll('.vote-btn:not(.voted-btn)');
          voteButtons.forEach(btn => btn.disabled = false);
        }, 1000);
        
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Yes, Vote';
        pendingVote = null;
      }
    }

    // Cancel vote
    function cancelVote() {
      document.getElementById('voteAlertOverlay').style.display = 'none';
      pendingVote = null;
    }

    // Close already voted alert
    function closeAlreadyVotedAlert() {
      document.getElementById('alreadyVotedOverlay').style.display = 'none';
    }

    // Handle logout
    async function handleLogout() {
      try {
        await window.signOut(window.auth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        showMessage('Error logging out. Please try again.', 'error');
      }
    }

    // Utility functions
    function showLoading() {
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('maleSection').classList.remove('active');
      document.getElementById('femaleSection').classList.remove('active');
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById(currentCategory + 'Section').classList.add('active');
    }

    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type}`;
      messageEl.style.display = 'block';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 5000);
    }

    function showConnectingPopup() {
      document.getElementById('connectingOverlay').style.display = 'flex';
    }

    function hideConnectingPopup() {
      document.getElementById('connectingOverlay').style.display = 'none';
    }

    // Auto-format tag input
    document.addEventListener('DOMContentLoaded', function() {
      const tagInput = document.getElementById('voteTagInput');
      
      tagInput.addEventListener('input', function(e) {
        const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        e.target.value = value;
        
        if (value.length === 6) {
          e.target.classList.remove('error');
        }
      });
      
      tagInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const cleaned = paste.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 6);
        e.target.value = cleaned;
      });

      // Add entrance animations to elements
      const elements = document.querySelectorAll('.fade-in, .slide-up');
      elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
      });
    });
  </script>
</body>
</html>